// Prisma Schema para Eletrostart
// Sistema de Mensagens de Contato
// Database: MongoDB Atlas

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// Modelo de Mensagem de Contato
model ContactMessage {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  source           String   @default("contact_form")
  name             String?
  email            String?
  phone            String?
  subject          String?
  message          String
  
  // Discord Sync Metadata
  discordSent      Boolean  @default(false)
  discordMessageId String?
  discordChannel   String?
  sentAt           DateTime?
  syncError        String?

  status           String   @default("NEW") // NEW, READ, REPLIED, ARCHIVED
  priority         String   @default("MEDIUM") // LOW, MEDIUM, HIGH
  
  // Internal Management
  notes            String?  // Notas internas (texto livre)
  assignedToId     String?  @db.ObjectId
  assignedTo       AdminUser? @relation(fields: [assignedToId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  
  tagIds           String[] @db.ObjectId
  tags             Tag[]    @relation(fields: [tagIds], references: [id])
  auditLogs        AuditLog[]

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("contact_messages")
  @@index([email])
  @@index([status])
  @@index([createdAt])
}

// Modelo de Usuário Administrativo
model AdminUser {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String   @unique
  password  String
  name      String?
  role      String   @default("ADMIN") // SUPER_ADMIN, ADMIN, VIEWER
  active    Boolean  @default(true)
  lastLogin DateTime?
  
  assignedMessages ContactMessage[]
  auditLogs        AuditLog[]
  statusChanges    OrderStatusHistory[]
  stockMovements   StockMovement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admin_users")
}

// Tags para classificação
model Tag {
  id         String           @id @default(auto()) @map("_id") @db.ObjectId
  name       String           @unique
  color      String           @default("#222998")
  messageIds String[]         @db.ObjectId
  messages   ContactMessage[] @relation(fields: [messageIds], references: [id])
  createdAt  DateTime         @default(now())

  @@map("tags")
}

// Log de Auditoria
model AuditLog {
  id          String         @id @default(auto()) @map("_id") @db.ObjectId
  action      String         // VIEW, UPDATE, DELETE, LOGIN, SYNC, etc.
  details     String?        // JSON string ou texto
  
  userId      String?        @db.ObjectId
  user        AdminUser?     @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  
  targetId    String?        // ID do objeto alvo
  targetType  String?        // MESSAGE, USER, SYSTEM
  
  messageId   String?        @db.ObjectId
  message     ContactMessage? @relation(fields: [messageId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  
  createdAt   DateTime       @default(now())

  @@map("audit_logs")
  @@index([createdAt])
  @@index([userId])
  @@index([action])
}

// Log de Integração (Discord, etc)
model IntegrationLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  service   String   @default("DISCORD")
  status    String   // SUCCESS, ERROR
  details   String?
  createdAt DateTime @default(now())

  @@map("integration_logs")
}

// --- Executive / Analytics Models ---

// Normalização de Cliente
model Customer {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  phone     String
  email     String?
  createdAt DateTime @default(now())

  @@map("customers")
  @@index([phone])
  @@index([email])
}

// Snapshot Analítico (gerado por cron)
model AnalyticsSnapshot {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  periodType  String   // "daily" | "monthly"
  periodRef   String   // "2025-01-27" | "2025-01"
  revenue     Float
  cost        Float
  grossProfit Float
  ordersCount Int
  avgTicket   Float
  createdAt   DateTime @default(now())

  @@map("analytics_snapshots")
  @@index([periodType, periodRef])
}

// --- E-commerce Models ---

// Categorias de Produtos
model Category {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  name        String    @unique
  slug        String    @unique
  description String?
  image       String?
  products    Product[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("categories")
}

// Produtos
model Product {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  price       Float     @default(0.0)
  stock       Int       @default(0)
  sku         String?   // @unique removido para permitir múltiplos nulos (produtos sem código)
  code        String?   // Código original da tabela
  image       String?   // URL da imagem principal
  unit        String?   @default("un") // un, kg, m, etc.
  
  categoryId  String?   @db.ObjectId
  category    Category? @relation(fields: [categoryId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  
  subcategory String?
  variants    Json?     // Native JSON support in MongoDB
  features    Json?     // Native JSON support in MongoDB
  specifications Json?  // Native JSON support in MongoDB
  images      Json?     // Native JSON support in MongoDB
  variantItems ProductVariant[]
  imageItems   ProductImage[]
  orderItems  OrderItem[]
  stockMovements StockMovement[]
  
  active      Boolean   @default(true)
  featured    Boolean   @default(false)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("products")
  @@index([name])
  @@index([categoryId])
  @@index([active])
  @@index([featured])
  @@index([price])
}

model ProductVariant {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  productId String  @db.ObjectId
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  name      String
  price     Float
  stock     Int
  sku       String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("product_variants")
  @@index([productId])
  @@index([sku])
}

model ProductImage {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  productId String  @db.ObjectId
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  url       String
  isPrimary Boolean @default(false)
  order     Int     @default(0)
  createdAt DateTime @default(now())

  @@map("product_images")
  @@index([productId])
}

// Pedidos
model Order {
  id            String      @id @default(auto()) @map("_id") @db.ObjectId
  
  // Vínculo analítico com Customer (opcional, sem relation formal para não quebrar dados antigos)
  customerId    String?     @db.ObjectId

  // Informações do Cliente (Simplificado por enquanto)
  customerName  String
  customerEmail String
  customerPhone String?
  customerDoc   String?     // CPF/CNPJ
  
  // Endereço de Entrega
  addressZip    String?
  addressStreet String?
  addressNumber String?
  addressComp   String?
  addressCity   String?
  addressState  String?
  
  // Totais
  subtotal      Float       @default(0.0)
  shippingCost  Float       @default(0.0)
  discount      Float       @default(0.0)
  total         Float       @default(0.0)
  
  // Status e Pagamento
  status        String      @default("PENDING") // PENDING, PAID, SHIPPED, DELIVERED, CANCELED
  paymentMethod String?     // CREDIT_CARD, PIX, BOLETO
  paymentStatus String      @default("PENDING") // PENDING, PAID, FAILED
  trackingCode  String?
  
  items          OrderItem[]
  statusHistory  OrderStatusHistory[]
  stockMovements StockMovement[]
  
  notes         String?     // Observações do cliente ou admin
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@map("orders")
  @@index([customerId])
  @@index([customerEmail])
  @@index([status])
  @@index([createdAt])
  @@index([paymentStatus])
}

model OrderStatusHistory {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  orderId     String    @db.ObjectId
  order       Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  status      String
  changedById String?   @db.ObjectId
  changedBy   AdminUser? @relation(fields: [changedById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  notes       String?
  createdAt   DateTime  @default(now())

  @@map("order_status_history")
  @@index([orderId])
  @@index([createdAt])
}

// Itens do Pedido
model OrderItem {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  
  orderId   String  @db.ObjectId
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId String? @db.ObjectId
  product   Product? @relation(fields: [productId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  
  productName  String   // Salva nome histórico caso produto seja deletado
  quantity     Int
  unitPrice    Float
  totalPrice   Float
  
  createdAt DateTime @default(now())

  @@map("order_items")
  @@index([productId])
}

model StockMovement {
  id            String     @id @default(auto()) @map("_id") @db.ObjectId
  productId     String     @db.ObjectId
  product       Product    @relation(fields: [productId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  orderId       String?    @db.ObjectId
  order         Order?     @relation(fields: [orderId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  type          String
  quantity      Int
  previousStock Int
  newStock      Int
  reason        String?
  createdById   String?    @db.ObjectId
  createdBy     AdminUser? @relation(fields: [createdById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  createdAt     DateTime   @default(now())

  @@map("stock_movements")
  @@index([productId])
  @@index([createdAt])
}
